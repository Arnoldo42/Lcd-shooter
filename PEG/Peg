#include <stdio.h>
#include <unistd.h>
#include <time.h>
#include <stdlib.h>

#define MAP_SIZE 10
#define MAX_ENEMIES 3

int gold = 4;
int score = 0;

int goalX = 1;
int goalY = 1;


int x = 2;
int y = 2;
char dir;

int loops = 0;

int enemyX[MAX_ENEMIES] = {3,7,1};
int enemyY[MAX_ENEMIES] = {4,0,8};
//nastavi pozice a gold a skore

int running = 1;
char status[100] = "";




#define RED   "\033[31m"
#define GREEN "\033[32m"
#define YELLOW "\033[33m"
#define RESET "\033[0m"
//Barvy








void restart();
void shockwave();
int enemyAt();
int checkDeath();
void move();
void show();
void enemyMove();

int main(){                                   //MAIN CODE Player. Enemy. Gold.
    srand(time(NULL));                                  //        P  E  G 
    while(running){
        loops++;
        
        printf("\n");   
        show();

        if(loops % 2 == 0){
            enemyMove();
            if(checkDeath()){
                show();
                printf("\nU DeD SUCKER\nUr score was only %i?\n",score);
                running = 0;
        }

        }
        move();
        if(checkDeath()){
            show();
            snprintf(status, sizeof(status),"\nU DeD SUCKER\nUr score was only %i?\n",score);
            running = 0;
        }
        
        usleep(100000);

    }

        
}
    

    






void show(){                          //VYKRESLENI POLE
    printf("\033[2J\033[H");

    printf(RED"Score: %d"RESET" |" ,score);
    printf(YELLOW" Gold: %d"RESET" |"GREEN" E = Shockwave (5G)\n"RESET,gold);
    printf("%s\n", status);

    for(int yMap = 0; yMap<MAP_SIZE;yMap++){

        printf("\n");

        for(int xMap = 0; xMap < MAP_SIZE; xMap++){

            if(xMap == x && yMap == y){
                printf(GREEN"P "RESET);
            }else if(xMap == goalX && yMap == goalY){
                printf(YELLOW"G "RESET);
            }else{
                int isEnemy = 0;

                for(int i=0; i < MAX_ENEMIES;i++){
                    if(xMap == enemyX[i] && yMap == enemyY[i]){
                        isEnemy = 1;
                        break;  
                    }
                    
                }
                if(isEnemy){
                    printf(RED"E "RESET);   
                }else{
                    printf("# ");
                }
                
            }
        }


    }

}





void move(){                                             //POHYB
    scanf(" %c", &dir);
    

    int newX =x;
    int newY = y;

    switch(dir){
        case 'w': newY--;break;
        case 's': newY++;break;
        case 'a': newX--;break;
        case 'd': newX++;break;
        case 'r': restart();return;
        case'e': shockwave();return;
        case 'q': snprintf(status,sizeof(status),"Man u are useless u have this litlle score %d and u are leaving?!\n", score);
        printf("The last one had this score: %i\n",score*10);
        running = 0;return;
        
        default: return;
    }

    if(newX>=MAP_SIZE||newX<0||newY>=MAP_SIZE||newY<0){
        return;
    }

    x = newX;
    y = newY;

    if(x== goalX && y == goalY){
        score++;
        gold++;
        snprintf(status,sizeof(status),"You did get 1 gold.");
        goalX = rand()%MAP_SIZE;
        goalY = rand()%MAP_SIZE;
    }

    
}


void enemyMove(){                                           //ENEMY AI

    for(int i = 0; i < MAX_ENEMIES;i++){

        int newX = enemyX[i];
        int newY = enemyY[i];  //testovaci hodnoty x a y


        int dx = x - enemyX[i];    
        int dy = y - enemyY[i];  //dx a dy je rozdil polohy hrace a enemy

        if(abs(dx)> abs(dy)){         // porovna absolutni hodnoty 
            newX += (dx > 0)? 1:-1;
        }else if (dy != 0){
            newY += (dy > 0)? 1:-1;// a tu vetsi zkrati pohybem smerem k hraci
        }
        if(enemyAt(newX,newY,i)){
            continue;   
        }
        enemyX[i] = newX;
        enemyY[i] = newY; // kdyz je vse v pohode tak se Enemy pohne
    }
}









int checkDeath(){           //konrola jestli je hrac mrtvy
    for(int i = 0; i < MAX_ENEMIES;i++){
        if(x == enemyX[i] && y == enemyY[i])
        return 1;
    }
    return 0;
}

int enemyAt(int x, int y, int self){ // aby se enemu neprekrivali
    for(int i = 0;i<MAX_ENEMIES;i++){
        if(i==self)continue;
        if(enemyX[i] == x && enemyY[i] == y){
            return 1;
        }
        
    }
    return 0;
}


void shockwave(){
    if(gold<5){
        gold = 0;
        snprintf(status,sizeof(status),"You broke ass, what are you trying?");
        usleep(100000);
        return;
    }
    gold-=5;


    for(int i = 0; i < MAX_ENEMIES; i++){

        if(
            enemyX[i] >= x-2 && enemyX[i] <= x+2 &&
            enemyY[i] >= y-2 && enemyY[i] <= y+2 // kdzy je nepritel ve ctverci 5x5 kde je stred hrac
        ){
            // respawn nepřítele jinam
            do{
                enemyX[i] = rand() % MAP_SIZE;
                enemyY[i] = rand() % MAP_SIZE;
            }while(
                (enemyX[i] == x && enemyY[i] == y )
            );
        }
    }
}


void restart(){
    gold = 4;
    score = 0;

    x = 2;
    y = 2;

    loops = 0;
    running = 1;

    status[0] = '\0';   // smaže text

    // náhodný gold
    goalX = rand() % MAP_SIZE;
    goalY = rand() % MAP_SIZE;

    // náhodní enemy
    for(int i = 0; i < MAX_ENEMIES; i++){
        do{
            enemyX[i] = rand() % MAP_SIZE;
            enemyY[i] = rand() % MAP_SIZE;
        }while(
            (enemyX[i] == x && enemyY[i] == y) ||
            (enemyX[i] == goalX && enemyY[i] == goalY)
        );
    }
}

//Ještě přidat:




//Boss 
//2 mistnost
//Novy enemy
//schopnost
